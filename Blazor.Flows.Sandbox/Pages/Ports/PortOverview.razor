@page "/port-overview"
@using Blazor.Flows.Events
@using Blazor.Flows.Behaviours

<MudGrid Spacing="2" Justify="Justify.Center" Style="height:100%; width: 100%; margin: 0;">

    <!-- LEFT PANEL: Documentation -->
    <MudItem xs="12" sm="4" Style="height: 100%; overflow-y: auto;">
        <MudPaper Class="pa-4 mud-height-full">
            <MudText Typo="Typo.h5" Color="Color.Primary" GutterBottom="true">Port Overview</MudText>

            <MudExpansionPanels MultiExpansion="false">

                <!-- Panel 1: What is a Port? -->
                <MudExpansionPanel Text="What is a Port?" Expanded="true">
                    <MudText Typo="Typo.body1" Class="mb-2">
                        Ports are the connection points on nodes and groups. They are the models (defined in <code>Port.cs</code>)
                        that links connect to.
                    </MudText>
                    <MudText Typo="Typo.body2" Class="mb-2">
                        Any model that implements <code>IPortContainer</code> (like <code>Node</code> or
                        <code>Group</code>) can have ports.
                    </MudText>
                    <MudText Typo="Typo.body2">
                        The default visual component for a port is <code>DefaultPortComponent.razor</code>, which
                        renders a simple circle.
                    </MudText>
                </MudExpansionPanel>

                <!-- Panel 2: Port Positioning -->
                <MudExpansionPanel Text="Port Positioning" >
                    <MudText Typo="Typo.body1" Class="mb-2">
                        A port's position is almost always calculated automatically based on its parent node/group. This
                        logic is controlled by two key enums:
                    </MudText>
                    <MudText Typo="Typo.h6" GutterBottom="true">1. PortAlignment</MudText>
                    <MudText Typo="Typo.body2" Class="mb-2">
                        The enum <code>PortAlignment.cs</code> determines which <strong>edge</strong> of the parent the
                        port will attach to.
                    </MudText>

                    <MudText Typo="Typo.h6" GutterBottom="true" Class="mt-3">2. PortJustification</MudText>
                    <MudText Typo="Typo.body2" Class="mb-2">
                        The enum <code>PortJustification.cs</code> determines <strong>where along that edge</strong> the
                        port will be placed.
                    </MudText>
                    <MudText Typo="Typo.body1" Class="mb-2">
                        You can finely adjust a port's position from its calculated alignment using the
                        **OffSetX** and **OffSetY** properties.
                    </MudText>

                    <MudText Typo="Typo.body2" Class="mb-2">
                        These properties define a pixel offset from the default position determined by
                        <span class="mud-code">PortAlignment</span> and <span class="mud-code">PortJustification</span>.
                    </MudText>
                    <CodeHighlighter Language="csharp" Code="@OffsetCode"/>
                    <MudText Typo="Typo.body2" Class="mt-2">
                        **Example:** An offset of <span class="mud-code">OffSetX = 20</span> on a
                        **Top**-aligned port will shift it 20 pixels to the right.
                    </MudText>
                    <MudAlert Severity="Severity.Info" Class="mb-3">
                        The exact positioning logic is defined inside the <code>@($"{nameof(PortBehaviour)}.cs")</code> class.
                    </MudAlert>
                    <MudText Typo="Typo.body2" Class="mt-2">
                        <strong>Note:</strong> <code>Start</code> and <code>End</code> are relative. For a
                        <strong>Left</strong> (vertical) edge, <code>Start</code> is the Top. For a <strong>Top</strong>
                        (horizontal) edge, <code>Start</code> is the Left.
                    </MudText>
                </MudExpansionPanel>
                
                <!-- Panel 3: Port Logic Overrides -->
                <MudExpansionPanel Text="Port Logic Overrides" >
                    <MudText Typo="Typo.body1" Class="mb-2">
                        You can control linking behavior by overriding methods from <code>Port.Features.cs</code> in a
                        custom port model.
                    </MudText>

                    <MudText Typo="Typo.h6" GutterBottom="true" Class="mt-3">1. CanCreateLink()</MudText>
                    <MudText Typo="Typo.body2" Class="mb-2">
                        This method determines if a user can create a new link from this port. By default, it
                        returns <code>true</code>. Below is an example of a port that can only have one outgoing link.
                    </MudText>
                    <CodeHighlighter Language="csharp" Code="@CanCreateLinkCode"/>

                    <MudText Typo="Typo.h6" GutterBottom="true" Class="mt-3">2. CanConnectTo(IPort port)</MudText>
                    <MudText Typo="Typo.body2" Class="mb-2">
                        This method is called when a user tries to drop a link onto this port. It allows you to validate
                        the connection.
                    </MudText>
                    <MudText Typo="Typo.body2" Class="mb-2">
                        The default logic prevents connecting a port to itself or to another port on the same parent.
                    </MudText>
                    <CodeHighlighter Language="csharp" Code="@CanConnectToCode"/>
                </MudExpansionPanel>
                
                <!-- Panel 4: How to Add Ports -->
                <MudExpansionPanel Text="How to Add Ports" >
                    <MudText Typo="Typo.body1" Class="mb-2">
                        You can easily add ports to any <code>IPortContainer</code> using the
                        <code>DiagramService</code>.
                    </MudText>
                    <CodeHighlighter Language="csharp" Code="@AddPortCode"/>
                </MudExpansionPanel>
                <MudExpansionPanel Text="Live Demo">
                    @if (SelectedNode is not null)
                    {
                        <MudSelect T="PortAlignment" Label="Alignment" @bind-Value="SelectedNode.Ports.First().Alignment" Class="mb-3" Immediate="true">
                            @foreach (PortAlignment alignment in Enum.GetValues(typeof(PortAlignment)))
                            {
                                <MudSelectItem Value="alignment">@alignment.ToString()</MudSelectItem>
                            }
                        </MudSelect>

                        <MudSelect T="PortJustification" Label="Justification" @bind-Value="SelectedNode.Ports.First().Justification" Class="mb-3" Immediate="true">
                            @foreach (PortJustification justification in Enum.GetValues(typeof(PortJustification)))
                            {
                                <MudSelectItem Value="justification">@justification.ToString()</MudSelectItem>
                            }
                        </MudSelect>

                        <MudNumericField T="int" Label="Offset X" @bind-Value="SelectedNode.Ports.First().OffsetX" Immediate="true" Step="1" Class="mb-3"/>
                        <MudNumericField T="int" Label="Offset Y" @bind-Value="SelectedNode.Ports.First().OffsetY" Immediate="true" Step="1"/>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">Select a node to edit its port.</MudAlert>
                    }
                   

                </MudExpansionPanel>
            </MudExpansionPanels>
        </MudPaper>
    </MudItem>

    <!-- RIGHT PANEL: Diagram -->
    <MudItem xs="12" sm="8" Style="height: 100%;">
        <MudPaper Class="mud-height-full" Elevation="4">
            <DiagramContainer DiagramService="Service"/>
        </MudPaper>
    </MudItem>

</MudGrid>

@code {
   [Inject] public IDiagramService Service { get; set; } = null!;
    
    // Live Demo Properties
    private INode? SelectedNode { get; set; }

    private const string AddPortCode =
        @"// 1. Create a node
        var node = new Node();
        node.SetPosition(50, 50);
        Service.AddNode(node);
        
        // 2. Define a port
        var port = new Port 
        { 
         Alignment = PortAlignment.Right, 
            Justification = PortJustification.Center 
        };
        
        // 3. Add the port to the node
        Service.AddPortTo(node, port);"; 
    private const string CanCreateLinkCode =
        @"// Example: Only allow 1 outgoing link
        public override bool CanCreateLink()
        {
            // HasOutGoingLinks is a property from Port.cs
            return !this.HasOutGoingLinks;
        }"; 
    private const string CanConnectToCode =
        @"// Example: Only allow connections from CustomPort
        public override bool CanConnectTo(IPort port)
        {
            // 1. Run the base logic (prevents self-connection)
            bool baseCanConnect = base.CanConnectTo(port);
            if (!baseCanConnect)
               [cite_start]return false; // [cite: 35]
                
            // 2. Add custom logic: only accept CustomPort
            return port is CustomPort;
        [cite_start]}"; 
    private const string OffsetCode =
        @"// Get a port (e.g., Top Center)
        var port = new Port 
        { 
            Alignment = PortAlignment.Top, 
            Justification = PortJustification.Center 
        };
        
        // Nudge it 20px to the right
        [cite_start]port.OffSetX = 20; // [cite: 40]
        
        [cite_start]Service.AddPortTo(myNode, port);"; // [cite: 41]
        
    protected override Task OnInitializedAsync()
    {
        var node1 = new Node();
        node1.SetPosition(50, 50);
        Service.AddNode(node1);
        Service.AddPortTo(node1, new Port { Alignment = PortAlignment.Right, Justification = PortJustification.Center });
        
        var node2 = new Node();
        node2.SetPosition(300, 50);
        Service.AddNode(node2);
        Service.AddPortTo(node2, new Port { Alignment = PortAlignment.Left, Justification = PortJustification.Center });
        Service.AddLinkTo(node1.Ports.First(), node2.Ports.First(), new CurvedLink());
        Service.Events.SubscribeTo<NodeSelectionChangedEvent>(OnNodeSelected);

        return base.OnInitializedAsync();
    }
    
    private void OnNodeSelected(NodeSelectionChangedEvent e)
    {
        if (e.Model.IsSelected)
        {
            SelectedNode = e.Model;
        }
        else
        {
            SelectedNode = null;
        }
        StateHasChanged(); 
       
    }
    
}

